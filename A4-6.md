# EBD: Database Specification Component

> Dynamic Q&A platform dedicated to helping young adults navigate the challenges of adult life and acquire essential life skills.

## A4: Conceptual Data Model

> The UML diagram in Figure 1 presents the main organizational entities, the relationships between them, attributes and their domains, and the multiplicity of relationships for the Geras platform.

### 1. Class diagram

![UML.png](./uml.png)
_Figure 1: Geras conceptual data model in UML._

### 2. Additional Business Rules

- **BR01**. A user cannot vote on their own questions, answers or comments.
- **BR02**. A user cannot answer their own questions.
- **BR03**. A user cannot have more than five annexes in a content version.
- **BR04**. The username must be between 5 and 30 characters long.
- **BR05**. The password must be between 8 and 30 characters long.
- **BR06**. The username must be unique.
- **BR07**. A user's score and level must be updated when votes related to their content change.
- **BR08**. A user's experience must be updated when they write a question or an answer.
- **BR09**. A question cannot exist without a tag.

---

## A5: Relational Schema, validation and schema refinement

> This artifact intends to present the relational schema, the schema validation and the schema refinement. The relational schema is the result of the transformation of the conceptual model into a relational model. The schema validation is the process of checking if the relational schema is in the Boyce-Codd Normal Form (BCNF).

### 1. Relational Schema

| Relation reference | Relation Compact Notation                                                                                                                                                                                                   |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| R01                | user(<u>id</u>, email <b>UK</b>, username <b>UK</b>, name, password, profile_picture, level <b>DF</b> 0, score <b>DF</b> 0, is_banned <b>DF<b> FALSE, is_admin <b>DF<b> FALSE, member_since)                                |
| R02                | tag(<u>id</u>, name <b>UK</b> <b>NN</b>, description <b>NN</b>)                                                                                                                                                             |
| R03                | badge(<u>id</u>, name <b>UK</b> <b>NN</b>, description <b>UK</b> <b>NN</b>, image <b>UK</b> <b>NN</b>)                                                                                                                      |
| R04                | question(<u>id</u>, title <b>NN</b>, correct_answer -> answer, author -> user)                                                                                                                                              |
| R05                | comment(<u>id</u>, comment_type <b>NN</b> <b>CK</b> <b>IN</b> MainContentTypes, id_question -> question, id_answer -> answer, author -> user)                                                                               |
| R06                | answer(<u>id</u>, id_question -> question, author -> user)                                                                                                                                                                  |
| R06                | content_version(<u>id</u>, body <b>NN</b>, date <b>DF</b> Now <b>NN</b>, content_type <b>NN</b> <b>CK</b> <b>IN</b> MainContentTypes, id_question -> question <b>NN</b>, id_answer -> answer <b>NN</b>)                     |
| R07                | annex(<u>id</u>, file_path <b>NN</b>, file_type <b>NN</b> <b>CK</b> <b>IN</b> FileTypes, content_type <b>NN</b> <b>CK</b> <b>IN</b> MainContentTypes, id_question -> question, id_answer -> answer)                         |
| R08                | vote(<u>id</u>, is_upvote <b>NN</b>, id_user -> user <b>NN</b>, content_type <b>NN</b> <b>CK</b> <b>IN</b> ContentTypes, id_question -> question <b>NN</b>, id_answer -> answer <b>NN</b>, id_comment -> comment <b>NN</b>) |
| R09                | notification(<u>id</u>, date <b>DF</b> Now <b>NN</b>, notification_type <b>NN</b> <b>CK</b> <b>IN</b> NotificationTypes, id_comment -> comment, id_answer -> answer, id_upvote -> vote, id_badge -> user_badge)             |
| R10                | user_badge(id_user <b>NN</b>, id_badge <b>NN</b>)                                                                                                                                                                           |
| R11                | faq(<u>id</u>, question <b>UK</b> <b>NN</b>, answer <b>NN</b>)                                                                                                                                                              |
| R12                | followed_questions(<u>question_id -> question</u> <b>NN</b>, <u>user_id -> user</u> <b>NN</b>)                                                                                                                              |
| R13                | followed_tags(<u>user_id -> user</u> <b>NN</b>, <u>tag_id -> tag</u> <b>NN</b>)                                                                                                                                             |
| R14                | followed_users(<u>follower_id -> user</u> <b>NN</b>, <u>followed_id -> user</u> <b>NN</b>)                                                                                                                                  |

Legend:

- UK: Unique Key
- DF: Default Value
- NN: Not Null
- CK: Check
- <u>underlined</u>: primary key
- ->: Foreign Key

### 2. Domains

| Domain Name       | Domain Specification                   |
| ----------------- | -------------------------------------- |
| Now               | TIMESTAMP DEFAULT CURRENT_TIMESTAMP    |
| NotificationTypes | ENUM ('ANSWER', 'UPVOTE', 'BADGE')     |
| FileTypes         | ENUM ('FILE', 'IMAGE')                 |
| ContentTypes      | ENUM ('QUESTION', 'ANSWER', 'COMMENT') |
| MainContentTypes  | ENUM ('QUESTION', 'ANSWER')            |

### 3. Schema validation

| **TABLE R01**                | user                                                                           |
| ---------------------------- | ------------------------------------------------------------------------------ |
| **Keys**                     | { id }, { email }, { username }                                                |
| **Functional Dependencies:** |                                                                                |
| FD0101                       | id->{email, username, name, password, profile_picture, level, score, is_admin} |
| FD0102                       | email->{id, username, name, password, profile_picture, level, score, is_admin} |
| FD0103                       | username->{id, email, name, password, profile_picture, level, score, is_admin} |
| **NORMAL FORM**              | BCNF                                                                           |

| **TABLE R02**                | tag                     |
| ---------------------------- | ----------------------- |
| **Keys**                     | { id }, { name }        |
| **Functional Dependencies:** |                         |
| FD0201                       | id->{name, description} |
| FD0202                       | name->{id, description} |
| **NORMAL FORM**              | BCNF                    |

| **TABLE R03**                | badge                                        |
| ---------------------------- | -------------------------------------------- |
| **Keys**                     | { id }, { name }, { description }, { image } |
| **Functional Dependencies:** |                                              |
| FD0301                       | id->{name, description, image}               |
| FD0302                       | name->{id, description, image}               |
| FD0303                       | description->{id, name, image}               |
| FD0303                       | image->{id, name, description}               |
| **NORMAL FORM**              | BCNF                                         |

| **TABLE R04**                | question                    |
| ---------------------------- | --------------------------- |
| **Keys**                     | { id }                      |
| **Functional Dependencies:** |                             |
| FD0401                       | id->{title, correct_answer} |
| **NORMAL FORM**              | BCNF                        |

| **TABLE R05**                | answer            |
| ---------------------------- | ----------------- |
| **Keys**                     | { id }            |
| **Functional Dependencies:** |                   |
| FD0501                       | id->{id_question} |
| **NORMAL FORM**              | BCNF              |

| **TABLE R06**                | comment                                                 |
| ---------------------------- | ------------------------------------------------------- |
| **Keys**                     | { id }                                                  |
| **Functional Dependencies:** |                                                         |
| FD0601                       | id->{id_question, comment_type, id_answer, id_question} |
| **NORMAL FORM**              | BCNF                                                    |

| **TABLE R07**                | correct_answer                 |
| ---------------------------- | ------------------------------ |
| **Keys**                     | { id_question }, { id_answer } |
| **Functional Dependencies:** |                                |
| FD0701                       | id_question, id_answer->{}     |
| **NORMAL FORM**              | BCNF                           |

| **TABLE R08**                | content_version                                                    |
| ---------------------------- | ------------------------------------------------------------------ |
| **Keys**                     | { id }                                                             |
| **Functional Dependencies:** |                                                                    |
| FD0801                       | id->{body, date, content_type, id_question, id_answer, id_comment} |
| **NORMAL FORM**              | BCNF                                                               |

| **TABLE R09**                | question_tag                |
| ---------------------------- | --------------------------- |
| **Keys**                     | { id_question }, { id_tag } |
| **Functional Dependencies:** |                             |
| FD0901                       | id_question, id_tag->{}     |
| **NORMAL FORM**              | BCNF                        |

| **TABLE R10**                | file                                                                  |
| ---------------------------- | --------------------------------------------------------------------- |
| **Keys**                     | { id }                                                                |
| **Functional Dependencies:** |                                                                       |
| FD1001                       | id->{file_path, file_type, main_content_type, id_question, id_answer} |
| **NORMAL FORM**              | BCNF                                                                  |

| **TABLE R11**                | vote                                                                    |
| ---------------------------- | ----------------------------------------------------------------------- |
| **Keys**                     | { id }                                                                  |
| **Functional Dependencies:** |                                                                         |
| FD1101                       | id->{is_upvote, id_user, vote_type, id_question, id_answer, id_comment} |
| **NORMAL FORM**              | BCNF                                                                    |

| **TABLE R12**                | notification                                                              |
| ---------------------------- | ------------------------------------------------------------------------- |
| **Keys**                     | { id }                                                                    |
| **Functional Dependencies:** |                                                                           |
| FD1201                       | id->{date, notification_type, id_comment, id_answer, id_upvote, id_badge} |
| **NORMAL FORM**              | BCNF                                                                      |

| **TABLE R13**                | user_badge                |
| ---------------------------- | ------------------------- |
| **Keys**                     | { id_user }, { id_badge } |
| **Functional Dependencies:** |                           |
| FD1301                       | id_user, id_badge->{}     |
| **NORMAL FORM**              | BCNF                      |

| **TABLE R14**                | faq                    |
| ---------------------------- | ---------------------- |
| **Keys**                     | { id }, { question }   |
| **Functional Dependencies:** |                        |
| FD1401                       | id->{question, answer} |
| FD0101                       | question->{id, answer} |
| **NORMAL FORM**              | BCNF                   |

| **TABLE R15**                | followed_questions           |
| ---------------------------- | ---------------------------- |
| **Keys**                     | { id_question }, { id_user } |
| **Functional Dependencies:** |                              |
| FD1501                       | id_question, id_user->{}     |
| **NORMAL FORM**              | BCNF                         |

| **TABLE R16**                | followed_tags           |
| ---------------------------- | ----------------------- |
| **Keys**                     | { id_user }, { id_tag } |
| **Functional Dependencies:** |                         |
| FD1601                       | id_user, id_tag->{}     |
| **NORMAL FORM**              | BCNF                    |

| **TABLE R17**                | followed_users                   |
| ---------------------------- | -------------------------------- |
| **Keys**                     | { id_follower }, { id_followed } |
| **Functional Dependencies:** |                                  |
| FD1701                       | id_follower, id_followed->{}     |
| **NORMAL FORM**              | BCNF                             |

> This schema is in the Boyce-Codd Normal Form (BCNF) as for every table, the left side of the functional dependencies are superkeys.

---

## A6: Indexes, triggers, transactions and database population

> This artifact intends to present the indexes, triggers, transactions and database population. These aspects are really important to the database performance and to the data integrity.
>
> - indexes help to improve the performance of the queries;
> - triggers help to maintain the data integrity and to automate some tasks;
> - transactions help to maintain the data integrity;
> - database population inserts the data into the database.

### 1. Database Workload

| **Relation reference** | **Relation Name**  | **Order of magnitude**       | **Estimated growth** |
| ---------------------- | ------------------ | ---------------------------- | -------------------- |
| R01                    | user               | 10k (tens of thousands)      | 10 / day             |
| R02                    | tag                | 100 (hundreds)               | 1 / day              |
| R03                    | badge              | 100 (hundreds)               | 0 / day              |
| R04                    | question           | 100k (hundreds of thousands) | 100 / day            |
| R05                    | answer             | 100k (hundreds of thousands) | 100 / day            |
| R06                    | comment            | 100k (hundreds of thousands) | 100 / day            |
| R07                    | correct_answer     | 10k (tens of thousands)      | 10 / day             |
| R08                    | content_version    | 100k (hundreds of thousands) | 100 / day            |
| R09                    | question_tag       | 100k (hundreds of thousands) | 100 / day            |
| R10                    | file               | 10k (tens of thousands)      | 100 / day            |
| R11                    | vote               | 1M (millions)                | 10k / day            |
| R12                    | notification       | 10M (tens of millions)       | 10k / day            |
| R13                    | user_badge         | 100k (hundred of thousands)  | 100 / day            |
| R14                    | faq                | 100 (hundreds)               | 0 / day              |
| R15                    | followed_questions | 1k (thousands)               | 10 / day             |
| R16                    | followed_tags      | 10k (tens of thousands)      | 100 / day            |
| R17                    | followed_users     | 10k (tens of thousands)      | 100 / day            |

### 2. Proposed Indices

#### 2.1. Performance Indices

| **Index**         | IDX01                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Relation**      | content_version                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Attribute**     | date                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Type**          | B-Tree                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Cardinality**   | Low                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Clustering**    | No                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Justification** | `content_version` stores all the current and previous versions of a post's body. Thus, to display a question, this table will have to be accessed cronologically and fetch the most recent entry. We chose to add this index because displaying a question or answer's body will be a very common operation, and the `content_version` table is very large, as it may hold multiple times the number of questions. The index type is B-Tree because we require sorted data. |
| `SQL code`        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |

```sql
CREATE INDEX most_recent_version ON content_version USING btree (date DESC NULLS LAST);
```

| **Index**         | IDX02                                                                                                                                                                                                                                                                                         |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Relation**      | vote                                                                                                                                                                                                                                                                                          |
| **Attribute**     | is_upvote                                                                                                                                                                                                                                                                                     |
| **Type**          | hash                                                                                                                                                                                                                                                                                          |
| **Cardinality**   | High                                                                                                                                                                                                                                                                                          |
| **Clustering**    | No                                                                                                                                                                                                                                                                                            |
| **Justification** | Votes will be fetched everytime a question, answer or comment is displayed, and split into upvotes and downvotes. Because `vote` is a very large table, and will be filtered for upvotes and downvotes very frequently, we chose to add a hash trigger to fetch different vote types quickly. |
| `SQL code`        |

```sql
 CREATE INDEX vote_type ON vote USING hash(is_upvote);
```

#### 2.2. Full-text Search Indices

> The system being developed must provide full-text search features supported by PostgreSQL. Thus, it is necessary to specify the fields where full-text search will be available and the associated setup, namely all necessary configurations, indexes definitions and other relevant details.

| **Index**         | IDX01                                                                                                                                                                              |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Relation**      | tag                                                                                                                                                                                |
| **Attribute**     | name                                                                                                                                                                               |
| **Type**          | GIN                                                                                                                                                                                |
| **Clustering**    | No                                                                                                                                                                                 |
| **Justification** | Users will be able to full-text search for tag names to easily find the one they are lookin for. The index type is GIN because we do not envision tag names will be altered often. |
| `SQL code`        |                                                                                                                                                                                    |

```sql
--tsvector trigger in triggers.sql

CREATE INDEX search_tag_name ON tag USING GIN (search_tag_name);
```

| **Index**         | IDX02                                                                                                                                                                                |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Relation**      | tag                                                                                                                                                                                  |
| **Attribute**     | description                                                                                                                                                                          |
| **Type**          | GIN                                                                                                                                                                                  |
| **Clustering**    | No                                                                                                                                                                                   |
| **Justification** | Users will be able to full-text search for tag descriptions when looking for a specific one. The index type is GIN because we do not envision tag descrptions will be altered often. |
| `SQL code`        |                                                                                                                                                                                      |

```sql
--tsvector trigger in triggers.sql

CREATE INDEX search_tag_description ON tag USING GIN (search_tag_description);
```

| **Index**         | IDX03                                                                                                                                                                                                                                                                               |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Relation**      | content_version                                                                                                                                                                                                                                                                     |
| **Attribute**     | body                                                                                                                                                                                                                                                                                |
| **Type**          | GIST                                                                                                                                                                                                                                                                                |
| **Clustering**    | No                                                                                                                                                                                                                                                                                  |
| **Justification** | Users will be able to full-text search for a question's body when looking for a specific one. `content_version` stores all the current and previous versions of a post's body. The index type is GIST because we envision a question's body may be altered frequently for editions. |
| `SQL code`        |                                                                                                                                                                                                                                                                                     |

```sql
--tsvector trigger in triggers.sql

CREATE INDEX search_question_body ON content_version USING GIST (search_body);
```

| **Index**         | IDX03                                                                                                                                                                              |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Relation**      | question                                                                                                                                                                           |
| **Attribute**     | title                                                                                                                                                                              |
| **Type**          | GIN                                                                                                                                                                                |
| **Clustering**    | No                                                                                                                                                                                 |
| **Justification** | Users will be able to full-text search a question's title when looking for a specific one. The index type is GIN because we do not envision question titles will be altered often. |
| `SQL code`        |                                                                                                                                                                                    |

```sql
--tsvector trigger in triggers.sql

CREATE INDEX search_question_title ON question USING GIN (search_title);
```

### 3. Triggers

| **Trigger**     | TRIGGER01                                                       |
| --------------- | --------------------------------------------------------------- |
| **Description** | The username, password and email must comply with certain rules |

```sql
CREATE FUNCTION verify_username_and_password() RETURNS TRIGGER AS
$BODY$
BEGIN
	IF TG_OP = 'INSERT' THEN
		IF NEW.username IS NULL THEN
		RAISE EXCEPTION 'Username cannot be NULL.';
		END IF;

		IF NEW.password IS NULL THEN
		RAISE EXCEPTION 'Password cannot be NULL.';
		END IF;

		IF NEW.email IS NULL THEN
		RAISE EXCEPTION 'Email cannot be NULL.';
		END IF;

		IF LENGTH(NEW.username) > 30 THEN
		RAISE EXCEPTION 'Username cannot be longer than 30 characters: %', NEW.username;
		END IF;

		IF LENGTH(NEW.username) < 5 THEN
		RAISE EXCEPTION 'Username cannot be shorter than 5 characters: %', NEW.username;
		END IF;

		IF (SELECT COUNT(*) FROM users WHERE username = NEW.username) > 0 THEN
		RAISE EXCEPTION 'Username must be unique: % already exists', NEW.username;
		END IF;
	ELSIF TG_OP = 'UPDATE' THEN
		IF NEW.password <> OLD.password THEN
			IF NEW.password IS NULL THEN
			RAISE EXCEPTION 'Password cannot be NULL.';
			END IF;
		END IF;
		IF NEW.email <> OLD.email THEN
			IF NEW.email IS NULL THEN
			RAISE EXCEPTION 'Email cannot be NULL.';
			END IF;
		END IF;
		IF NEW.username <> OLD.username THEN
			IF NEW.username IS NULL THEN
			RAISE EXCEPTION 'Username cannot be NULL.';
			END IF;

			IF LENGTH(NEW.username) > 30 THEN
			RAISE EXCEPTION 'Username cannot be longer than 30 characters: %', NEW.username;
			END IF;

			IF LENGTH(NEW.username) < 5 THEN
			RAISE EXCEPTION 'Username cannot be shorter than 5 characters: %', NEW.username;
			END IF;

			IF (SELECT COUNT(*) FROM users WHERE username = NEW.username) > 0 THEN
			RAISE EXCEPTION 'Username must be unique: % already exists', NEW.username;
			END IF;
		END IF;
	END IF;

    RETURN NEW;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER verify_username_and_password
        BEFORE INSERT OR UPDATE ON users
        FOR EACH ROW
        EXECUTE PROCEDURE verify_username_and_password();
```

| **Trigger**     | TRIGGER02                                          |
| --------------- | -------------------------------------------------- |
| **Description** | The user's score must be updated when votes change |

```sql
CREATE FUNCTION update_score() RETURNS TRIGGER AS
$BODY$
BEGIN
    IF TG_OP = 'INSERT' THEN
        IF NEW.is_upvote THEN
            --Increase score by 1 for an upvote
            UPDATE users
            SET score = score + 1
            WHERE id = NEW.id_user;
        ELSE
            --Decrease score by 1 for a downvote
            UPDATE users
            SET score = score - 1
            WHERE id = NEW.id_user;
        END IF;
    ELSIF TG_OP = 'DELETE' THEN
        IF OLD.is_upvote THEN
            --Decrease score by 1 for a deleted upvote
            UPDATE users
            SET score = score - 1
            WHERE id = OLD.id_user;
        ELSE
            --Increase score by 1 for a deleted downvote
            UPDATE users
            SET score = score + 1
            WHERE id = OLD.id_user;
        END IF;
    END IF;

    RETURN NULL;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER update_score
        AFTER INSERT OR DELETE ON vote
        FOR EACH ROW
        EXECUTE PROCEDURE update_score();
```

| **Trigger**     | TRIGGER03                                                                                                       |
| --------------- | --------------------------------------------------------------------------------------------------------------- |
| **Description** | A notification must be sent after an answer is written. A similiar procedure is used for the upvotes and badges |

```sql
CREATE FUNCTION send_answer_notification() RETURNS TRIGGER AS
$BODY$
BEGIN
    INSERT INTO notification (date, type, id_answer, id_user)
    VALUES (NOW(), 'ANSWER', NEW.id, NEW.author);

    RETURN NULL;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER send_answer_notification
        AFTER INSERT ON answer
        FOR EACH ROW
        EXECUTE PROCEDURE send_answer_notification();
```

| **Trigger**     | TRIGGER06                                                                                                            |
| --------------- | -------------------------------------------------------------------------------------------------------------------- |
| **Description** | Text search vectors must be updated for the questions. A similiar procedure is used for the tags and content version |

```sql
CREATE FUNCTION tsvectors_update_question() RETURNS TRIGGER AS
$BODY$
BEGIN
    IF TG_OP = 'INSERT' THEN
        NEW.search_title = setweight(to_tsvector('english', NEW.title), 'A');
    END IF;

    IF TG_OP = 'UPDATE' THEN
        IF NEW.title <> OLD.title THEN
            NEW.search_title = setweight(to_tsvector('english', NEW.title), 'A');
        END IF;
    END IF;

    RETURN NEW;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER tsvectors_update_question
        BEFORE INSERT OR UPDATE ON question
        FOR EACH ROW
        EXECUTE PROCEDURE tsvectors_update_question();
```

| **Trigger**     | TRIGGER09                               |
| --------------- | --------------------------------------- |
| **Description** | If a question has no tag, it is removed |

```sql
CREATE FUNCTION remove_question_no_tag() RETURNS TRIGGER AS
$BODY$
DECLARE
    question_id INT;
    question_count INT;
BEGIN
    question_id := OLD.id;

    DELETE FROM question_tag WHERE id_tag = question_id;

    FOR question_id IN SELECT DISTINCT id_question FROM question_tag
    LOOP
        SELECT COUNT(*) INTO question_count FROM question_tag WHERE id_question = question_id;

        IF question_count = 0 THEN
            DELETE FROM question WHERE id = question_id;
        END IF;
    END LOOP;

    RETURN OLD;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER remove_question_no_tag
        BEFORE DELETE ON tag
        FOR EACH ROW
        EXECUTE PROCEDURE remove_question_no_tag();
```

| **Trigger**     | TRIGGER10                                                                                   |
| --------------- | ------------------------------------------------------------------------------------------- |
| **Description** | A user gains experience by writing a question. A similiar procedure is used for the answers |

```sql
CREATE FUNCTION update_experience_question() RETURNS TRIGGER AS
$BODY$
BEGIN
    UPDATE users
    SET experience = experience + 2
    WHERE id = NEW.author;

    RETURN NULL;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER update_experience_question
        AFTER INSERT ON question
        FOR EACH ROW
        EXECUTE PROCEDURE update_experience_question();
```

| **Trigger**     | TRIGGER12                                                     |
| --------------- | ------------------------------------------------------------- |
| **Description** | A content version cannot be related to more than five annexes |

```sql
CREATE FUNCTION verify_annexes() RETURNS TRIGGER AS
$BODY$
BEGIN
    IF (SELECT COUNT(*) FROM annex WHERE id_version = NEW.id) > 5 THEN
        RAISE EXCEPTION 'A content version cannot have more than five annexes.';
    END IF;

    RETURN NEW;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER verify_annexes
        AFTER INSERT ON content_version
        FOR EACH ROW
        EXECUTE PROCEDURE verify_annexes();
```

| **Trigger**     | TRIGGER13                                                                                                      |
| --------------- | -------------------------------------------------------------------------------------------------------------- |
| **Description** | Prevent self-voting on questions, answers and comments. A similiar procedure is used to prevent self-answering |

```sql
CREATE FUNCTION prevent_self_voting() RETURNS TRIGGER AS
$BODY$
BEGIN
    IF NEW.type = 'QUESTION' AND NEW.id_user = (SELECT author FROM question WHERE id = NEW.id_question) THEN
        RAISE EXCEPTION 'You cannot vote on your own question';
    END IF;

    IF NEW.type = 'ANSWER' AND NEW.id_user = (SELECT author FROM answer WHERE id = NEW.id_answer) THEN
        RAISE EXCEPTION 'You cannot vote on your own answer';
    END IF;

    IF NEW.type = 'COMMENT' AND NEW.id_user = (SELECT author FROM comments WHERE id = NEW.id_comment) THEN
        RAISE EXCEPTION 'You cannot vote on your own comment';
    END IF;

  RETURN NEW;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER prevent_self_voting
        BEFORE INSERT ON vote
        FOR EACH ROW
        EXECUTE PROCEDURE prevent_self_voting();
```

| **Trigger**     | TRIGGER15                                                                                                                         |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| **Description** | A badge should be given when a user asks a question for the first time. A similiar procedure is used for 10, 50 and 100 questions |

```sql
CREATE FUNCTION badge_first_question() RETURNS TRIGGER AS
$BODY$
BEGIN
   IF (SELECT COUNT(*)
    FROM question
    WHERE author = NEW.author) = 1 THEN
        INSERT INTO user_badge (id_user, id_badge)
        VALUES (NEW.author, (SELECT id FROM badge WHERE name = 'First Question'));
    END IF;

    RETURN NEW;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER badge_first_question
        AFTER INSERT ON question
        FOR EACH ROW
        EXECUTE PROCEDURE badge_first_question();
```

| **Trigger**     | TRIGGER19                                                                                                               |
| --------------- | ----------------------------------------------------------------------------------------------------------------------- |
| **Description** | A badge should be given when a user answers for the first time. A similiar procedure is used for 10, 50 and 100 answers |

```sql
CREATE FUNCTION badge_first_answer() RETURNS TRIGGER AS
$BODY$
BEGIN
    IF(SELECT COUNT(*)
    FROM answer
    WHERE author = NEW.author) = 1 THEN
        INSERT INTO user_badge (id_user, id_badge)
        VALUES (NEW.author, (SELECT id FROM badge WHERE name = 'First Answer'));
    END IF;

    RETURN NEW;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER badge_first_answer
        AFTER INSERT ON answer
        FOR EACH ROW
        EXECUTE PROCEDURE badge_first_answer();
```

| **Trigger**     | TRIGGER23                                                                                                                 |
| --------------- | ------------------------------------------------------------------------------------------------------------------------- |
| **Description** | A badge should be given when a user comments for the first time. A similiar procedure is used for 10, 50 and 100 comments |

```sql
CREATE FUNCTION badge_first_comment() RETURNS TRIGGER AS
$BODY$
BEGIN
    IF (SELECT COUNT(*)
    FROM comments
    WHERE author = NEW.author) = 1 THEN
        INSERT INTO user_badge (id_user, id_badge)
        VALUES (NEW.author, (SELECT id FROM badge WHERE name = 'First Comment'));
    END IF;

    RETURN NEW;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER badge_first_comment
        AFTER INSERT ON comments
        FOR EACH ROW
        EXECUTE PROCEDURE badge_first_comment();
```

| **Trigger**     | TRIGGER27                                                                                                          |
| --------------- | ------------------------------------------------------------------------------------------------------------------ |
| **Description** | A badge should be given when a user receives the first upvote. A similiar procedure is used for the first downvote |

```sql
CREATE FUNCTION badge_first_upvote() RETURNS TRIGGER AS
$BODY$
BEGIN
        IF (SELECT COUNT(*) FROM
            vote JOIN question ON vote.id_question = question.id JOIN answer ON vote.id_answer = answer.id JOIN comments ON vote.id_comment = comments.id
            WHERE vote.id_user = NEW.id_user AND is_upvote = true) = 1 THEN
            INSERT INTO user_badge (id_user, id_badge)
            VALUES (NEW.id_user, (SELECT id FROM badge WHERE name = 'First Upvote'));
        END IF;

    RETURN NEW;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER badge_first_upvote
        AFTER INSERT ON vote
        FOR EACH ROW
        EXECUTE PROCEDURE badge_first_upvote();
```

| **Trigger**     | TRIGGER29                                                                                                                    |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| **Description** | A badge should be given when a user reaches a score of 100. A similiar procedure is used for a score of 1000, 5000 and 10000 |

```sql
CREATE FUNCTION badge_100_score() RETURNS TRIGGER AS
$BODY$
BEGIN
    IF NEW.is_upvote = true THEN
        IF (SELECT score FROM users WHERE id = NEW.id_user) = 100 AND
           (SELECT COUNT(*) FROM user_badge WHERE id_user = NEW.id_user AND id_badge = (SELECT id FROM badge WHERE name = '100 Score')) = 0 THEN
            INSERT INTO user_badge (id_user, id_badge)
            VALUES (NEW.id_user, (SELECT id FROM badge WHERE name = '100 Score'));
        END IF;
    END IF;

    RETURN NEW;
END
$BODY$
LANGUAGE plpgsql;

CREATE TRIGGER badge_100_score
        AFTER INSERT ON vote
        FOR EACH ROW
        EXECUTE PROCEDURE badge_100_score();
```

| **Function**    | FUNCTION01                                                                                     |
| --------------- | ---------------------------------------------------------------------------------------------- |
| **Description** | Returns BannedUser if a user with a given id is banned; returns the user's username otherwise. |

```sql
CREATE FUNCTION get_display_name(user_id INT) RETURNS TEXT AS
$BODY$
DECLARE
    user_username TEXT;
    user_is_banned BOOLEAN;
BEGIN
    SELECT username, is_banned INTO user_username, user_is_banned
    FROM users
    WHERE id = user_id;

    IF user_is_banned THEN
        RETURN 'BannedUser';
    ELSE
        RETURN user_username;
    END IF;
END
$BODY$
LANGUAGE plpgsql;
```

### 4. Transactions

| Tran01          | Adding annexes when creating a new question                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Justification   | When creating a new question with annexes, files and images, we only want them to be added to the table if the question is successfully created, and its first content version added.                                                                                                                                                                                                                                                                                                                      |
| Isolation level | In order to maintain consistency, a transaction is necessary to ensure that all the code executes without errors. If an error occurs, a ROLLBACK is issued, reverting the changes (e.g. when the insertion of a content version fails). The isolation level is Repeatable Read, because, otherwise, an update of question_seq_id or content_version_seq_id could happen, due to an insert in the table question committed by a concurrent transaction, and as a result, inconsistent data would be stored. |

```sql
   BEGIN TRANSACTION;
   SET TRANSACTION ISOLATION LEVEL REPEATABLE READ

   INSERT INTO question (title, author)
   VALUES ($title, $author);

   INSERT INTO content_version (body, type, id_question)
   VALUES ($body, 'QUESTION', currval('question_seq_id'));

   INSERT INTO annex (type, file_path, id_version)
   VALUES($type, $file_path, currval('content_version_seq_id'));


   END TRANSACTION;
```

| Tran02          | Adding annexes when creating an answer                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- |
| Justification   | When creating a new answers with annexes, files and images, we only want them to be added to the table if the answer is successfully created, and its first content version added.                                                                                                                                                                                                                                                                                                                       |
| Isolation level | In order to maintain consistency, a transaction is necessary to ensure that all the code executes without errors. If an error occurs, a ROLLBACK is issued, reverting the changes (e.g. when the insertion of a content version fails). The isolation level is Repeatable Read, because, otherwise, an update of answer_seq_id or content_version_seq_id could happen, due to an insert in the table question committed by a concurrent transaction, and as a result, inconsistent data would be stored. |     |

```sql
   BEGIN TRANSACTION;
   SET TRANSACTION ISOLATION LEVEL REPEATABLE READ

   INSERT INTO answer (author, id_question)
   VALUES ($author, $idquestion);

   INSERT INTO content_version (body, type, id_answer)
   VALUES ($body, 'ANSWER', currval('answer_seq_id'));

   INSERT INTO annex (type, file_path, id_version)
   VALUES($type, $file_path, currval('content_version_seq_id'));


   END TRANSACTION;
```

## Annex A. SQL Code

### A.1. Database schema

```postgresql
SET search_path TO lbaw2326;

-----------------------------------------
-- Drop old schema
-----------------------------------------

DROP TABLE IF EXISTS followed_users CASCADE;
DROP TABLE IF EXISTS followed_tags CASCADE;
DROP TABLE IF EXISTS followed_questions CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS tag CASCADE;
DROP TABLE IF EXISTS badge CASCADE;
DROP TABLE IF EXISTS question CASCADE;
DROP TABLE IF EXISTS answer CASCADE;
DROP TABLE IF EXISTS comments CASCADE;
DROP TABLE IF EXISTS correct_answer CASCADE;
DROP TABLE IF EXISTS content_version CASCADE;
DROP TABLE IF EXISTS question_tag CASCADE;
DROP TABLE IF EXISTS annex CASCADE;
DROP TABLE IF EXISTS vote CASCADE;
DROP TABLE IF EXISTS notification CASCADE;
DROP TABLE IF EXISTS user_badge CASCADE;
DROP TABLE IF EXISTS faq CASCADE;

DROP TYPE IF EXISTS notification_type CASCADE;
DROP TYPE IF EXISTS file_type CASCADE;
DROP TYPE IF EXISTS content_type CASCADE;
DROP TYPE IF EXISTS main_content_type CASCADE;

-----------------------------------------
-- Types
-----------------------------------------

CREATE TYPE notification_type AS ENUM ('ANSWER', 'UPVOTE', 'BADGE');
CREATE TYPE file_type AS ENUM ('FILE', 'IMAGE');
CREATE TYPE content_type AS ENUM ('QUESTION', 'ANSWER', 'COMMENT');
CREATE TYPE main_content_type AS ENUM ('QUESTION', 'ANSWER');

-----------------------------------------
-- Tables
-----------------------------------------

-- Note that plural names 'users' and 'comments' were adopted because of reserved words in PostgreSQL.
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email TEXT NOT NULL CONSTRAINT user_email_uk UNIQUE,
    name TEXT,
    username TEXT NOT NULL,
    password TEXT NOT NULL,
    profile_picture TEXT,
    experience INTEGER DEFAULT 0,
    score INTEGER DEFAULT 0,
    member_since DATE DEFAULT now(),
	is_banned BOOLEAN DEFAULT FALSE,
    is_admin BOOLEAN DEFAULT FALSE
    );

CREATE TABLE tag (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    search_tag_name TSVECTOR NOT NULL,
    description TEXT NOT NULL,
    search_tag_description TSVECTOR NOT NULL
);

CREATE TABLE badge (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    description TEXT NOT NULL UNIQUE,
    image_path TEXT NOT NULL UNIQUE
);

CREATE TABLE question (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    search_title TSVECTOR NOT NULL,
    author INTEGER NOT NULL REFERENCES users (id) ON DELETE SET NULL
);

CREATE TABLE answer (
    id SERIAL PRIMARY KEY,
    author INTEGER NOT NULL REFERENCES users (id) ON DELETE SET NULL,
    id_question INTEGER NOT NULL REFERENCES question (id) ON DELETE CASCADE
);

CREATE TABLE comments (
    id SERIAL PRIMARY KEY,
    body TEXT NOT NULL,
    type main_content_type NOT NULL,
    date TIMESTAMP default now() NOT NULL,
    author INTEGER NOT NULL REFERENCES users (id) ON DELETE SET NULL,
    id_question INTEGER REFERENCES question (id) ON DELETE CASCADE,
    id_answer INTEGER REFERENCES answer (id) ON DELETE CASCADE,
    CHECK (
        (type = 'QUESTION' AND id_question IS NOT NULL AND id_answer IS NULL) OR
        (type = 'ANSWER' AND id_question IS NULL AND id_answer IS NOT NULL)
    )
);

CREATE TABLE correct_answer (
    id_question INTEGER NOT NULL REFERENCES question (id) ON DELETE CASCADE,
    id_answer INTEGER NOT NULL REFERENCES answer (id) ON DELETE CASCADE,
    PRIMARY KEY (id_question, id_answer)
);

CREATE TABLE content_version (
    id SERIAL PRIMARY KEY,
    body TEXT NOT NULL,
    search_body TSVECTOR NOT NULL,
    date TIMESTAMP DEFAULT now() NOT NULL,
    type main_content_type NOT NULL,
    id_question INTEGER REFERENCES question (id) ON DELETE CASCADE,
    id_answer INTEGER REFERENCES answer (id) ON DELETE CASCADE,
    CHECK (
        (type = 'QUESTION' AND id_question IS NOT NULL AND id_answer IS NULL) OR
        (type = 'ANSWER' AND id_question IS NULL AND id_answer IS NOT NULL)
    )
);

CREATE TABLE question_tag (
    id_question INTEGER NOT NULL REFERENCES question (id) ON DELETE CASCADE,
    id_tag INTEGER NOT NULL REFERENCES tag (id), --Temos um trigger para quando se apaga uma tag
    PRIMARY KEY (id_question, id_tag)
);

CREATE TABLE annex (
    id SERIAL PRIMARY KEY,
    type file_type NOT NULL,
    file_path TEXT NOT NULL,
    id_version INTEGER NOT NULL REFERENCES content_version (id) ON DELETE CASCADE
);

CREATE TABLE vote (
    id SERIAL PRIMARY KEY,
    is_upvote BOOLEAN NOT NULL,
    type content_type NOT NULL,
    id_user INTEGER NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    id_question INTEGER REFERENCES question (id) ON DELETE CASCADE,
    id_answer INTEGER REFERENCES answer (id) ON DELETE CASCADE,
    id_comment INTEGER REFERENCES comments (id) ON DELETE CASCADE
    CHECK (
        (type = 'QUESTION' AND id_question IS NOT NULL AND id_answer IS NULL AND id_comment IS NULL) OR
        (type = 'ANSWER' AND id_question IS NULL AND id_answer IS NOT NULL AND id_comment IS NULL) OR
        (type = 'COMMENT' AND id_question IS NULL AND id_answer IS NULL AND id_comment IS NOT NULL)
    )
);

CREATE TABLE user_badge (
    id_user INTEGER NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    id_badge INTEGER NOT NULL REFERENCES badge (id) ON DELETE CASCADE,
    date DATE DEFAULT now() NOT NULL,
    PRIMARY KEY (id_user, id_badge)
);

CREATE TABLE notification (
    id SERIAL PRIMARY KEY,
    date TIMESTAMP DEFAULT now() NOT NULL,
    type notification_type NOT NULL,
    id_answer INTEGER REFERENCES answer (id) ON DELETE CASCADE,
    id_upvote INTEGER REFERENCES vote (id) ON DELETE CASCADE,
    id_badge INTEGER REFERENCES badge(id) ON DELETE CASCADE,
    id_user INTEGER NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    CHECK (
        (type = 'ANSWER' AND id_answer IS NOT NULL AND id_upvote IS NULL AND id_badge IS NULL) OR
        (type = 'UPVOTE' AND id_answer IS NULL AND id_upvote IS NOT NULL AND id_badge IS NULL) OR
        (type = 'BADGE' AND id_answer IS NULL AND id_upvote IS NULL AND id_badge IS NOT NULL)
    )
);

CREATE TABLE faq (
    id SERIAL PRIMARY KEY,
    question TEXT NOT NULL UNIQUE,
    answer TEXT NOT NULL
);

CREATE TABLE followed_questions (
    id_user INTEGER NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    id_question INTEGER NOT NULL REFERENCES question (id) ON DELETE CASCADE,
    PRIMARY KEY (id_user, id_question)
);

CREATE TABLE followed_tags (
    id_user INTEGER NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    id_tag INTEGER NOT NULL REFERENCES tag (id) ON DELETE CASCADE,
    PRIMARY KEY (id_user, id_tag)
);

CREATE TABLE followed_users (
    id_follower INTEGER NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    id_followed INTEGER NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    PRIMARY KEY (id_follower, id_followed)
);
```

### A.2. Database population

```postgresql
SET
    search_path TO lbaw2326;

INSERT INTO
    users (
        email,
        name,
        username,
        password,
        profile_picture,
        experience,
        score,
        is_banned,
        is_admin,
        member_since
    )
VALUES
    (
        'user1@example.com',
        'John Smith',
        'jsmith',
        '$2y$10$1qAzY9UGNbT/N9wX26Oz9OfRj38uSyvBf86hsA0s4tY1o4l4.IRL2',
        '/userFiles/profilePics/profile1.jpg',
        10,
        100,
        false,
        true,
        '2023-10-20'
    ),
    (
        'user2@example.com',
        'Emily Johnson',
        'ejohnson',
        '$2y$10$hGVyf4OoCZ8gjOWR/bWWBO1VtWQV9/K8vWeMCTovMCzgrfCgTtA7m',
        '/userFiles/profilePics/profile2.jpg',
        5,
        75,
        false,
        true,
        '2023-10-15'
    ),
    (
        'user3@example.com',
        'Michael Williams',
        'mwilliams',
        '$2y$10$J7v4ie4C0hTVnxjtEmuOsbZPfi1HPWhL0.1Qg2hqC3PLSbE1MQYra',
        '/userFiles/profilePics/profile3.jpg',
        15,
        200,
        false,
        true,
        '2023-10-25'
    ),
    (
        'user4@example.com',
        'Sophia Jones',
        'sjones',
        '$2y$10$e6ixWp.8eNqGdNWAPdJlMuPGWw8tUV7TVlwK3WjBqsJvIHgCBTpI6',
        '/userFiles/profilePics/profile4.jpg',
        20,
        250,
        false,
        true,
        '2023-10-30'
    ),
    (
        'user5@example.com',
        'William Davis',
        'wdavis',
        '$2y$10$aP/3ex.d5DyzT9UjWxR9TOq/0l7B4zMeJ8AjJsLf6vcW.4QF2o3wG',
        '/userFiles/profilePics/profile5.jpg',
        8,
        90,
        false,
        true,
        '2023-10-17'
    ),
    (
        'user6@example.com',
        'Olivia Martinez',
        'omartinez',
        '$2y$10$IRm6eZki4Vly9q/Qef9/iu5e.sjJG7s0Q0Gy51WJ4vlme04FJYjpe',
        '/userFiles/profilePics/profile6.jpg',
        12,
        150,
        false,
        true,
        '2023-10-22'
    ),
    (
        'user7@example.com',
        'James Brown',
        'jbrown',
        '$2y$10$0HVYvWTqRO8Sasqj3cTxGOTZgbl85IjfaAq6q7H.o.3ctk2w6nc/q',
        '/userFiles/profilePics/profile7.jpg',
        25,
        300,
        false,
        false,
        '2023-11-01'
    ),
    (
        'user8@example.com',
        'Charlotte Wilson',
        'cwilson',
        '$2y$10$3WGOq8tGKcn.HT.dZ5I16epYjY3JL0UKaKbFRDduObRmtCsnB2F2O',
        '/userFiles/profilePics/profile8.jpg',
        7,
        80,
        false,
        true,
        '2023-10-16'
    ),
    (
        'user9@example.com',
        'Benjamin Taylor',
        'btaylor',
        '$2y$10$5HCN8mzN/F1g9cAhP1GhuHf3KdeKJdizsdQbjq6N3sP9dx0Si54Oi',
        '/userFiles/profilePics/profile9.jpg',
        18,
        220,
        false,
        true,
        '2023-10-27'
    ),
    (
        'user10@example.com',
        'Emma Anderson',
        'eanderson',
        '$2y$10$WofMh33rSPWUMAwucVlsTus9VjSZLRRuUUG4btd2LM5F1..4bESa6',
        '/userFiles/profilePics/profile10.jpg',
        14,
        170,
        false,
        true,
        '2023-10-23'
    );

INSERT INTO
    tag (name, description)
VALUES
    (
        'Budgeting',
        'Managing personal finances and budgeting'
    ),
    ('Cooking', 'Learning to cook and preparing meals'),
    ('Laundry', 'Doing laundry and clothing care'),
    ('Cleaning', 'House cleaning and maintenance'),
    (
        'Time Management',
        'Effective time management and productivity'
    ),
    (
        'Job Search',
        'Searching for jobs and career development'
    ),
    (
        'Renting',
        'Renting apartments and property management'
    ),
    (
        'Healthcare',
        'Managing healthcare and medical appointments'
    ),
    (
        'Insurance',
        'Understanding and managing insurance policies'
    ),
    ('Taxes', 'Filing taxes and tax planning');

INSERT INTO
    badge (name, description, image_path)
VALUES
    (
        'First Question',
        'Asked your first question',
        '/assets/badges/first_question.png'
    ),
    (
        '10 Questions',
        'Asked 10 questions',
        '/assets/badges/10_questions.png'
    ),
    (
        '50 Questions',
        'Asked 50 questions',
        '/assets/badges/50_questions.png'
    ),
    (
        '100 Questions',
        'Asked 100 questions',
        '/assets/badges/100_questions.png'
    ),
    (
        'First Answer',
        'Answered your first question',
        '/assets/badges/first_answer.png'
    ),
    (
        '10 Answers',
        'Provided 10 answers',
        '/assets/badges/10_answers.png'
    ),
    (
        '50 Answers',
        'Provided 50 answers',
        '/assets/badges/50_answers.png'
    ),
    (
        '100 Answers',
        'Provided 100 answers',
        '/assets/badges/100_answers.png'
    ),
    (
        'First Correct Answer',
        'Received your first accepted answer',
        '/assets/badges/first_accepted_answer.png'
    ),
    (
        '10 Correct Answers',
        'Received 10 accepted answers',
        '/assets/badges/10_accepted_answers.png'
    );

INSERT INTO
    question (title, author)
VALUES
    ('How to Create a Budget for Living Alone', 3),
    ('Simple Recipes for Beginners', 6),
    (
        'Tips for Doing Laundry Without Ruining Clothes',
        9
    ),
    ('Effective Cleaning Routines for a Tidy Home', 12),
    ('Time Management Techniques for Productivity', 15),
    ('Strategies for a Successful Job Search', 18),
    (
        'Essential Tips for Renting Your First Apartment',
        21
    ),
    ('Navigating Healthcare Options in Portugal', 24),
    ('Understanding Different Types of Insurance', 27),
    (
        'Tax Filing Tips for Students and Young Adults',
        30
    );

INSERT INTO
    answer (author, id_question)
VALUES
    (1, 1),
    (2, 1),
    (3, 2),
    (4, 2),
    (5, 3),
    (6, 3),
    (7, 4),
    (8, 4),
    (9, 5),
    (10, 5);

INSERT INTO
    correct_answer (id_question, id_answer)
VALUES
    (1, 3),
    (2, 6),
    (3, 9),
    (4, 12),
    (5, 15),
    (6, 18),
    (7, 21),
    (8, 24),
    (9, 27),
    (10, 30);

INSERT INTO
    content_version (body, type, id_answer, id_question)
VALUES
    (
        'Creating a budget for living alone can be a crucial step towards financial independence. Here are some tips to get you started:',
        'QUESTION',
        NULL,
        1
    ),
    (
        'To create a budget for living alone, start by calculating your monthly income and listing all your expenses. Allocate a portion for rent, utilities, groceries, and savings. Make adjustments as needed to stay within your means.',
        'ANSWER',
        1,
        NULL
    ),
    (
        'Cooking doesn''t have to be complicated! Here are some simple and delicious recipes perfect for beginners:',
        'QUESTION',
        NULL,
        2
    ),
    (
        'Try making a hearty vegetable stir-fry or a classic spaghetti aglio e olio. These recipes are easy to follow and require minimal ingredients.',
        'ANSWER',
        2,
        NULL
    ),
    (
        'Doing laundry may seem daunting, but with the right techniques, you can keep your clothes in great condition. Here are some tips:',
        'QUESTION',
        NULL,
        3
    ),
    (
        'Sort your laundry by color and fabric type to prevent color bleeding or fabric damage. Use the right amount of detergent and avoid overloading the machine. Follow garment care labels for best results.',
        'ANSWER',
        3,
        NULL
    ),
    (
        'Maintaining a tidy home is essential for a clear mind and productivity. Here are some effective cleaning routines to follow:',
        'QUESTION',
        NULL,
        4
    ),
    (
        'Establish a daily routine that includes tasks like making the bed, doing the dishes, and wiping down surfaces. Set aside time for deeper cleaning on a weekly basis, focusing on different areas of your home.',
        'ANSWER',
        4,
        NULL
    ),
    (
        'Time management is crucial for productivity in both work and personal life. Here are some techniques to help you make the most of your time:',
        'QUESTION',
        NULL,
        5
    ),
    (
        'Consider using techniques like the Pomodoro Technique for focused work sessions, and prioritize tasks based on their importance and deadlines. Set realistic goals and use tools like calendars and to-do lists.',
        'ANSWER',
        5,
        NULL
    );

INSERT INTO
    question_tag (id_question, id_tag)
VALUES
    (21, 4),
    (34, 2),
    (2, 6),
    (43, 9),
    (42, 12),
    (12, 8),
    (4, 2),
    (64, 5),
    (32, 2),
    (1, 5);

INSERT INTO
    annex (type, file_path, id_version)
VALUES
    ('FILE', '/UserFiles/files/file2.txt', 3),
    ('FILE', '/UserFiles/files/file3.pdf', 4),
    ('FILE', '/UserFiles/files/file4.doc', 5),
    ('FILE', '/UserFiles/files/file5.xlsx', 6),
    ('FILE', '/UserFiles/files/file6.csv', 7),
    ('FILE', '/UserFiles/files/file7.zip', 8),
    ('FILE', '/UserFiles/files/file8.png', 9),
    ('FILE', '/UserFiles/files/file9.jpg', 10),
    ('FILE', '/UserFiles/files/file10.txt', 11),
    ('FILE', '/UserFiles/files/file11.pdf', 12);

INSERT INTO
    faq (question, answer)
VALUES
    (
        'How do I report a user for inappropriate behavior?',
        'To report a user for inappropriate behavior, navigate to their profile and look for the "Report" or "Flag" option. Describe the issue and provide evidence if possible. The platforms moderation team will review your report.'
    ),
    (
        'How can I post a question on this platform?',
        'To post a question, click on the "Ask a Question" or "Post button". Write a clear and concise title and provide details in the body of the question. Choose relevant tags and submit. Be sure to follow community guidelines.'
    ),
    (
        'What are upvotes, and how do they work?',
        'Upvotes are a way for the community to express appreciation for helpful content. To upvote a question or answer, click the up arrow. Upvoted content is more visible and contributes to user reputation.'
    ),
    (
        'Can I retract an upvote?',
        'You can retract an upvote by clicking the up arrow again.'
    );

INSERT INTO
    comments (body, type, author, id_question, id_answer)
VALUES
    (
        'Great tips for budgeting! This will definitely help me manage my finances better.',
        'QUESTION',
        1,
        1,
        NULL
    ),
    (
        'I''m glad you found the budgeting tips helpful. Let me know if you have any questions!',
        'ANSWER',
        2,
        NULL,
        1
    ),
    (
        'These recipes look delicious. Can''t wait to try them!',
        'QUESTION',
        3,
        2,
        NULL
    ),
    (
        'Enjoy cooking those recipes! They''re simple and tasty.',
        'ANSWER',
        4,
        NULL,
        2
    ),
    (
        'The laundry tips are a lifesaver. Thanks for sharing!',
        'QUESTION',
        5,
        3,
        NULL
    ),
    (
        'You''re welcome! Laundry doesn''t have to be a chore with the right techniques.',
        'ANSWER',
        6,
        NULL,
        3
    ),
    (
        'I''ve started following the cleaning routines, and my home feels so much better.',
        'QUESTION',
        7,
        4,
        NULL
    ),
    (
        'That''s great to hear! A tidy home can positively impact your daily life.',
        'ANSWER',
        8,
        NULL,
        4
    ),
    (
        'The time management techniques are helping me stay productive. Thanks!',
        'QUESTION',
        9,
        5,
        NULL
    ),
    (
        'You''re welcome! Time management is key for productivity. Keep up the good work!',
        'ANSWER',
        10,
        NULL,
        5
    );

INSERT INTO
    correct_answer (id_question, id_answer)
VALUES
    (1, 1),
    (2, 4),
    (3, 5),
    (4, 7),
    (5, 10),
    (6, 11),
    (7, 13),
    (9, 17),
    (10, 20),
    (11, 21);

INSERT INTO
    user_badge (id_user, id_badge, date)
VALUES
    (3, 1, '2023-10-30'),
    (5, 1, '2023-10-19'),
    (6, 1, '2023-12-27'),
    (12, 1, '2023-11-07'),
    (12, 2, '2023-11-09'),
    (13, 1, '2023-02-05'),
    (18, 9, '2023-08-10'),
    (22, 9, '2023-11-04'),
    (24, 1, '2023-02-25'),
    (24, 2, '2023-03-28');

INSERT INTO
    followed_questions (id_user, id_question)
VALUES
    (5, 54),
    (21, 24),
    (34, 21),
    (1, 21),
    (2, 41),
    (43, 1),
    (42, 53),
    (12, 86),
    (4, 2),
    (64, 52);

INSERT INTO
    followed_tags (id_user, id_tag)
VALUES
    (1, 13),
    (1, 14),
    (2, 9),
    (2, 15),
    (3, 2),
    (4, 3),
    (5, 6),
    (8, 5),
    (8, 12),
    (8, 13);

INSERT INTO
    followed_users (id_follower, id_followed)
VALUES
    (1, 2),
    (1, 3),
    (1, 4),
    (1, 5),
    (2, 1),
    (3, 1),
    (4, 1),
    (5, 1),
    (5, 15),
    (5, 78);

INSERT INTO
    vote (
        is_upvote,
        type,
        id_comment,
        id_answer,
        id_question,
        id_user
    )
VALUES
    (true, 'QUESTION', NULL, NULL, 4, 1),
    (false, 'ANSWER', NULL, 3, NULL, 2),
    (true, 'ANSWER', NULL, 10, NULL, 3),
    (true, 'COMMENT', 21, NULL, NULL, 4),
    (false, 'COMMENT', 11, NULL, NULL, 5),
    (true, 'ANSWER', NULL, 7, NULL, 6),
    (false, 'QUESTION', NULL, NULL, 6, 7),
    (true, 'QUESTION', NULL, NULL, 12, 8),
    (false, 'COMMENT', 45, NULL, NULL, 9),
    (true, 'QUESTION', NULL, NULL, 5, 10);
```

---

## Revision history

Changes made to the first submission:

1.

---

GROUP2326, 25/10/2023

- Diogo Filipe Couto Monteiro, up202108800@up.pt
- Diogo Tomás Valente Fernandes, up202108752@up.pt (Editor)
- Edudardo Luís Fernandes Roçadas, up202108757@up.pt
- Maria Rita Nogueira Lopes, up202108819@up.pt
